# Universal Windows Platform
# Build a Universal Windows Platform project using Visual Studio.
# Add steps that test and distribute an app, save build artifacts, and more:
# https://aka.ms/yaml

trigger:
- master

pool:
  vmImage: 'windows-2019'

variables:
  solutionXCG: '**/XamlControlsGallery.sln'
  solutionUITests: '**/UITests.sln'
  buildPlatform: 'x64'
  buildConfiguration: 'Debug'
  appxPackageDir: '$(build.artifactStagingDirectory)\AppxPackages\\'

stages:
  - stage: Build
    jobs:
      - job:
        displayName: Build $(buildConfiguration) $(buildPlatform)
        steps:
        - task: NuGetToolInstaller@1
          displayName: Install NuGet 5.8.0
          inputs:
            versionSpec: 5.8.0

        - task: NuGetCommand@2
          displayName: Restore packages
          inputs:
            restoreSolution: '$(solutionXCG)'

        - task: VSBuild@1
          inputs:
            platform: $(buildPlatform)
            solution: '$(solutionXCG)'
            configuration: '$(buildConfiguration)'
            msbuildArgs: '/p:AppxBundlePlatforms="$(buildPlatform)" /p:AppxPackageDir="$(appxPackageDir)" /p:AppxBundle=Always /p:UapAppxPackageBuildMode=SideloadOnly /p:AppxPackageSigningEnabled=true'

        - task: VSBuild@1
          inputs:
            platform: $(buildPlatform)
            solution: '$(solutionUITests)'
            configuration: '$(buildConfiguration)'
        
        - task: PublishPipelineArtifact@1
          inputs:
            targetPath: '$(System.DefaultWorkingDirectory)\XAMLControlsGallery\bin\$(buildConfiguration)\buildPlatform'
            artifact: 'uitests_$(buildConfiguration)_$(buildPlatform)'
            publishLocation: 'pipeline'
            
        - task: PublishPipelineArtifact@1
          inputs:
            targetPath: '$(Build.ArtifactStagingDirectory)\AppxPackages\'
            artifact: 'appxbundles_$(buildConfiguration)_$(buildPlatform)'
            publishLocation: 'pipeline'

  
  - stage: Testing
    dependsOn: Build
    jobs:
      - job: 
        displayName: Interaction tests $(buildConfiguration) $(buildPlatform)
        steps:
          - task: NuGetToolInstaller@1
            displayName: Install NuGet 5.8.0
            inputs:
              versionSpec: 5.8.0

          - task: NuGetCommand@2
            displayName: Restore packages
            inputs:
              restoreSolution: '$(solutionUITests)'

          - task: DownloadPipelineArtifact@2
            inputs:
              buildType: 'current'
              artifactName: 'uitests_$(buildConfiguration)_$(buildPlatform)'
              targetPath: '$(System.DefaultWorkingDirectory)\artifacts\$(buildConfiguration)'
          
          - task: DownloadPipelineArtifact@2
            inputs:
              buildType: 'current'
              artifactName: 'appxbundles_$(buildConfiguration)_$(buildPlatform)'
              targetPath: '$(System.DefaultWorkingDirectory)\appxbundles'

          - task: DownloadBuildArtifacts@0
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'artifacts_$(buildConfiguration)_$(buildPlatform)'
              downloadPath: '$(System.DefaultWorkingDirectory)\appxbundles'

          - task: PowerShell@2
            inputs:
              targetType: 'inline'
              script: |
                # Find correct folder and run app install script.
                cd ./appxbundles

                $AppBundle = Get-ChildItem -Filter XamlControlsGallery -Name
                echo $AppBundle
                cd $AppBundle
                ./Add-AppDevPackage.ps1 -Force
              errorActionPreference: 'continue'
              failOnStderr: true
              workingDirectory: '$(System.DefaultWorkingDirectory)'

          - task: Windows Application Driver@0
            inputs:
              OperationType: 'Start'
              AgentResolution: '1080p'

          - task: VSTest@2
            inputs:
              testSelector: 'testAssemblies'
              testAssemblyVer2: |
                **\bin\Debug\net5.0\UITests.dll
                !**\*TestAdapter.dll
                !**\obj\**
              searchFolder: '$(System.DefaultWorkingDirectory)'

          - task: Windows Application Driver@0
            inputs:
              OperationType: 'Stop'